# mysql锁
## 行锁和表锁
表锁：锁定整张表  
行锁：锁定表中的某些行  

## 共享锁和排他锁
类似于读写锁  

## 意向锁
意向共享锁（IS）：事务在给数据行加行级共享锁之前，必须先取得该表的 IS 锁  
意向排他锁（IX）：事务在给数据行加行级排他锁之前，必须先取得该表的 IX 锁   
特点：表级锁，InnoDB自动添加，无需用户干预  

## 行锁
### 记录锁
锁定表中某些确定的行  

### Gap锁
锁定间隙  

### next-key锁
记录锁 + 间隙锁

## 插入意向锁
属于间隙锁，而不是意向锁   
作用：提高并发插入的性能。间隙锁不允许多个事务同时插入同一个索引间隙，但是插入意向锁允许多个事务同时插入同一个索引间隙内的不同数据值   


# 加锁原理
InnoDB加的行锁是netx-key锁  
如果锁的主键索引记录存在，则退化成纪录锁  
如果锁的主键索引记录不存在，则加间隙锁  

唯一索引等值查询：  
当查询的记录是存在的，next-key lock 会退化成「记录锁」。当查询的记录是不存在的，next-key lock 会退化成「间隙锁」。  

非唯一索引等值查询：  
当查询的记录存在时，除了会加 next-key lock 外，还额外加间隙锁，也就是会加两把锁。当查询的记录不存在时，只会加 next-key lock，然后会退化为间隙锁，也就是只会加一把锁。  

非唯一索引和主键索引的范围查询的加锁规则不同之处在于：  
唯一索引在满足一些条件的时候，next-key lock 退化为间隙锁和记录锁。非唯一索引范围查询，next-key lock 不会退化为间隙锁和记录锁。  


# 参考资料
https://www.cnblogs.com/better-farther-world2099/articles/14955475.html  
https://xiaolincoding.com/mysql/lock/how_to_lock.html#mysql-%E6%98%AF%E6%80%8E%E4%B9%88%E5%8A%A0%E8%A1%8C%E7%BA%A7%E9%94%81%E7%9A%84

