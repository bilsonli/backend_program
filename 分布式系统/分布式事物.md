# 常见分布式事物解决方案
## 2PC
### 过程
1）协调者向所有参与者发起资源预扣请求   
2）如果1）有一个返回失败，则执行回滚操作，否则发起提交请求  

### 缺点
1）同步阻塞，某个参与者的资源被其他事物锁定，需要等待  
2）协调者宕机，prepare阶段之后，参与者无法知道要怎么做  
3）数据不一致问题，commit阶段或者rollback阶段，某个节点没有收到消息，导致数据不一致  


## 3PC
### 过程
1）协调者发起资源查询请求，参与者查看是否满足要求，这一阶段超时导致失败  
2）协调者发起资源预扣请求，参与者扣减资源，这一阶段超时导致成功  
3）协调者发起资源提交请求，参与者提交本地事物，这一阶段超时导致成功   


### 优点
1）增加询问询阶段，可以减少无法完成操作的可能  
2）增加了超时机制，防止了永久阻塞  

### 缺点
1）无法完全解决数据不一致问题（例如：第2阶段某个参与者没有收到预扣资源请求或者第3阶段某个节点没有提交）  

## TCC
### 过程
1）Try阶段预扣资源，该阶段失败或者超时，执行cancel阶段  
2）Confirm阶段提交资源, 该阶段超时或者失败，则需要重试  
3）Cancel阶段回滚操作，该阶段超时或者失败，则需要重试  

### 缺点
1）重试过程中需要保证幂等性  

## MQ
![image](https://github.com/user-attachments/assets/40b52f65-a97e-443e-81aa-86ccf200fe99)

### 过程
1）生产者本地执行事务成功后（添加一条消息到本地消息表），后台服务去发送消息给MQ，直到MQ返回ACK
2）消费者收到MQ消息后，执行幂等性操作（消息去重）  

### 最大努力可靠
存一张本地消息表，后台任务发送消息，直到MQ响应ACK  

### 问题
1）消费者执行commit失败怎么处理？  怎么通知到生产者？  

### seata 
阿里推出的支持AT、TCC、SAGA 和 XA 四种事务模式  


## 最终一致性方案
1）轮询  
2）补偿机制  
3）定期对账  



## 参考资料
https://cloud.tencent.com/developer/article/1806989
https://github.com/allentofight/easy-cs/tree/main/%E5%88%86%E5%B8%83%E5%BC%8F
